# Advanced Action Plugin - 高度なレコードアクション機能

## 概要

kintoneには、アプリAに存在するレコードのフィールド情報をコピーし、アプリBに新規レコードとして登録する「アクションボタン」機能があります。

しかし、この標準機能には以下のような制約があります。

- 対応していないフィールドタイプがある
  - サブテーブルフィールド
  - ファイルフィールド
- 異なるフィールドタイプ間でのコピーができない
- そのアプリに存在するフィールドしかコピーできない
- 固定値や計算結果を設定できない

このプラグインは、このような制約を克服し、kintoneアプリ間でのレコードコピー機能を提供する高度なアクションプラグインです。

プラグインはアプリ単位でしか適応できない特性上、コピー元アプリ、コピー先アプリそれぞれにプラグインを設定する必要があります。

## 主要機能

### アプリ間連携

サブテーブルやファイルフィールドを含む、あらゆるフィールドタイプに対応したレコードコピーを実現します。

また、特定のキー情報をもとに、異なるアプリ間でのデータ連携も可能です。

例えば、アプリAの顧客IDフィールドと一致するアプリBのレコードを取得し、複合した情報をアプリCにコピーする、といった高度な連携も実現できます。

### 柔軟なフィールドマッピング

フィールドタイプが異なる場合でも、柔軟にマッピング設定が可能です。さらに、固定値や計算結果をコピー先フィールドに設定できます。

## 技術仕様

### アーキテクチャ
- **フレームワーク**: React + TypeScript
- **状態管理**: Jotai
- **UIライブラリ**: Material-UI + Radix UI
- **スタイリング**: TailwindCSS + Emotion
- **データ処理**: Zod + LZ-String（圧縮）

### 主要ライブラリ
- **kintone操作**: @konomi-app/kintone-utilities
- **ドラッグ&ドロップ**: @dnd-kit
- **通知**: notistack
- **日時処理**: Luxon
- **関数型処理**: Remeda

## プロジェクト構造

```
src/
├── components/           # 共通UIコンポーネント
├── config/              # 設定画面（プラグイン管理者向け）
├── desktop/             # 動作画面（エンドユーザー向け）
├── lib/                 # 共通ライブラリ・ユーティリティ
├── schema/              # データ検証・型定義
└── styles/              # スタイル定義
```

## 設定データ構造

### PluginCondition（設定単位）
```typescript
{
  id: string              // 設定の一意識別子
  mode: 'source' | 'destination'  // 動作モード
  dstAppId: string        // コピー先アプリID
  buttonLabel: string     // アクションボタンのラベル
  fields: FieldMapping[]  // フィールドマッピング設定
  users: Permission[]     // 権限設定
}
```

### FieldMapping（フィールド設定）
```typescript
{
  type: 'copy' | 'fixed_value' | 'calc'  // マッピング種別
  srcFieldCode: string    // コピー元フィールドコード
  dstFieldCode: string    // コピー先フィールドコード
  fixedValue?: string     // 固定値（type='fixed_value'時）
}
```

## エントリポイント

### 設定画面（config）
- **目的**: プラグインの設定・管理
- **対象**: kintone管理者・アプリ作成者
- **機能**: アプリ間連携の設定、フィールドマッピング、権限管理

### 動作画面（desktop）
- **目的**: 実際のレコード操作機能の提供
- **対象**: エンドユーザー
- **機能**: アクションボタンの表示、レコードコピーの実行

## 特徴的な実装

### 1. 圧縮されたクエリパラメータ
- LZ-Stringを使用してURLパラメータを圧縮
- 大量のデータを効率的に画面間で受け渡し

### 2. 動的コンポーネント管理
- ComponentManagerによるReactコンポーネントの動的描画
- kintoneのDOM構造に柔軟に対応

### 3. イベントドリブン設計
- カスタムイベントマネージャーによる処理の分離
- 保守性と拡張性を重視した設計

## 開発・ビルド

```bash
# 開発モード（ファイル監視 + 自動デプロイ）
npm run dev

# プロダクションビルド
npm run build

# スタンドアロン版ビルド
npm run standalone
```

このプラグインは、kintoneの標準機能では実現困難な高度なレコード操作を、直感的なUI設計で提供することを目標としています。